# API Authentication

Complete guide to authenticating with the Affelios API and managing access credentials.

## Authentication Overview

### Authentication Methods
The Affelios API supports multiple authentication methods to accommodate different use cases and security requirements:

1. **API Key Authentication** (Primary)
   - Simple bearer token authentication
   - Suitable for server-to-server integrations
   - Long-lived credentials with configurable expiration
   - Scope-based permission control

2. **OAuth 2.0** (Coming Soon)
   - Industry-standard authorization framework
   - Suitable for user-facing applications
   - Short-lived access tokens with refresh capability
   - Granular permission scoping

3. **Webhook Signatures**
   - HMAC-based request verification
   - Ensures webhook authenticity
   - Prevents request tampering
   - Configurable signature algorithms

## API Key Authentication

### Generating API Keys

1. **Via Dashboard**
   - Navigate to Account Settings > API Keys
   - Click "Generate New API Key"
   - Provide descriptive name and select scopes
   - Copy and securely store the generated key

2. **Via API**
   ```bash
   curl -X POST https://api.affelios.com/v1/auth/api-keys \
     -H "Authorization: Bearer YOUR_SESSION_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "name": "My Integration",
       "scopes": ["affiliates:read", "programs:write", "reports:read"],
       "expires_at": "2024-12-31T23:59:59Z"
     }'
   ```

### API Key Structure
```
aff_live_1234567890abcdef1234567890abcdef
│   │    │
│   │    └── Random key material (32 characters)
│   └── Environment indicator (live/test)
└── Affelios prefix
```

### Using API Keys

1. **Bearer Token Header**
   ```http
   Authorization: Bearer aff_live_1234567890abcdef1234567890abcdef
   ```

2. **JavaScript Example**
   ```javascript
   const response = await fetch('https://api.affelios.com/v1/account', {
     headers: {
       'Authorization': 'Bearer ' + apiKey,
       'Content-Type': 'application/json'
     }
   });
   ```

3. **Python Example**
   ```python
   import requests
   
   headers = {
       'Authorization': f'Bearer {api_key}',
       'Content-Type': 'application/json'
   }
   
   response = requests.get('https://api.affelios.com/v1/account', headers=headers)
   ```

4. **PHP Example**
   ```php
   $ch = curl_init();
   curl_setopt($ch, CURLOPT_URL, 'https://api.affelios.com/v1/account');
   curl_setopt($ch, CURLOPT_HTTPHEADER, [
       'Authorization: Bearer ' . $apiKey,
       'Content-Type: application/json'
   ]);
   curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
   
   $response = curl_exec($ch);
   curl_close($ch);
   ```

## Permission Scopes

### Available Scopes
```json
{
  "account": {
    "read": "Read account information",
    "write": "Modify account settings"
  },
  "affiliates": {
    "read": "View affiliate data",
    "write": "Create and modify affiliates",
    "delete": "Remove affiliates"
  },
  "programs": {
    "read": "View program information",
    "write": "Create and modify programs",
    "manage": "Full program management"
  },
  "campaigns": {
    "read": "View campaign data",
    "write": "Create and modify campaigns",
    "manage": "Full campaign management"
  },
  "tracking": {
    "read": "View tracking data",
    "write": "Submit tracking events"
  },
  "reports": {
    "read": "Access reporting data",
    "export": "Export report data"
  },
  "payments": {
    "read": "View payment information",
    "process": "Process payments"
  },
  "webhooks": {
    "read": "View webhook configurations",
    "write": "Create and modify webhooks"
  }
}
```

### Scope Selection Best Practices
1. **Principle of Least Privilege**
   - Request only necessary permissions
   - Avoid overly broad scopes
   - Regularly review and update scopes
   - Use separate keys for different purposes

2. **Scope Combinations**
   ```json
   {
     "name": "Reporting Dashboard",
     "scopes": ["reports:read", "reports:export", "affiliates:read"]
   }
   ```

## Key Management

### Security Best Practices
1. **Secure Storage**
   ```bash
   # Use environment variables
   export AFFELIOS_API_KEY="aff_live_1234567890abcdef1234567890abcdef"
   
   # Or secure configuration files
   echo "AFFELIOS_API_KEY=aff_live_..." > .env
   chmod 600 .env
   ```

2. **Key Rotation**
   ```javascript
   // Automated key rotation example
   const rotateApiKey = async () => {
     // Generate new key
     const newKey = await generateNewKey();
     
     // Update application configuration
     await updateConfiguration({ apiKey: newKey });
     
     // Revoke old key after validation
     await revokeOldKey(oldKey);
   };
   ```

### Key Lifecycle Management
1. **Key States**
   - **Active**: Fully functional key
   - **Restricted**: Limited functionality
   - **Expired**: Past expiration date
   - **Revoked**: Manually disabled

2. **Key Monitoring**
   ```bash
   # Check key status
   curl -X GET https://api.affelios.com/v1/auth/api-keys/current \
     -H "Authorization: Bearer YOUR_API_KEY"
   ```

### Multiple Key Management
```json
{
  "keys": [
    {
      "id": "key_123",
      "name": "Production Integration",
      "scopes": ["affiliates:read", "reports:read"],
      "last_used": "2023-10-15T14:30:00Z",
      "expires_at": "2024-10-15T00:00:00Z"
    },
    {
      "id": "key_456",
      "name": "Development Testing",
      "scopes": ["*"],
      "last_used": "2023-10-14T09:15:00Z",
      "expires_at": "2023-11-15T00:00:00Z"
    }
  ]
}
```

## OAuth 2.0 (Preview)

### Authorization Code Flow
1. **Authorization Request**
   ```http
   GET https://api.affelios.com/oauth/authorize?
     response_type=code&
     client_id=YOUR_CLIENT_ID&
     redirect_uri=https://yourapp.com/callback&
     scope=affiliates:read programs:read&
     state=random_state_string
   ```

2. **Token Exchange**
   ```bash
   curl -X POST https://api.affelios.com/oauth/token \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "grant_type=authorization_code" \
     -d "client_id=YOUR_CLIENT_ID" \
     -d "client_secret=YOUR_CLIENT_SECRET" \
     -d "code=AUTH_CODE" \
     -d "redirect_uri=https://yourapp.com/callback"
   ```

3. **Token Response**
   ```json
   {
     "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
     "token_type": "Bearer",
     "expires_in": 3600,
     "refresh_token": "def502009e8c1a...",
     "scope": "affiliates:read programs:read"
   }
   ```

### Client Credentials Flow
```bash
curl -X POST https://api.affelios.com/oauth/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials" \
  -d "client_id=YOUR_CLIENT_ID" \
  -d "client_secret=YOUR_CLIENT_SECRET" \
  -d "scope=reports:read"
```

## Webhook Authentication

### HMAC Signature Verification
1. **Signature Generation**
   ```python
   import hmac
   import hashlib
   
   def verify_webhook_signature(payload, signature, secret):
       expected_signature = hmac.new(
           secret.encode('utf-8'),
           payload.encode('utf-8'),
           hashlib.sha256
       ).hexdigest()
       
       return hmac.compare_digest(f"sha256={expected_signature}", signature)
   ```

2. **Webhook Headers**
   ```http
   X-Affelios-Signature-256: sha256=a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3
   X-Affelios-Delivery: 12345678-1234-1234-1234-123456789012
   X-Affelios-Event: conversion.created
   ```

3. **Verification Example**
   ```javascript
   const crypto = require('crypto');
   
   function verifyWebhookSignature(payload, signature, secret) {
     const expectedSignature = crypto
       .createHmac('sha256', secret)
       .update(payload, 'utf8')
       .digest('hex');
   
     const expectedHeader = `sha256=${expectedSignature}`;
     return crypto.timingSafeEqual(
       Buffer.from(signature),
       Buffer.from(expectedHeader)
     );
   }
   ```

## Error Handling

### Authentication Errors
```json
{
  "errors": [
    {
      "code": "INVALID_API_KEY",
      "status": "401",
      "title": "Invalid API Key",
      "detail": "The provided API key is invalid or has been revoked"
    }
  ]
}
```

### Common Error Codes
- `MISSING_AUTHORIZATION`: No authorization header provided
- `INVALID_API_KEY`: API key is invalid or revoked
- `EXPIRED_API_KEY`: API key has expired
- `INSUFFICIENT_SCOPE`: API key lacks required permissions
- `RATE_LIMITED`: Too many requests from this key

### Error Handling Examples
```javascript
async function handleApiRequest(url, options) {
  try {
    const response = await fetch(url, options);
    
    if (response.status === 401) {
      // Handle authentication error
      throw new Error('Authentication failed - check API key');
    }
    
    if (response.status === 403) {
      // Handle authorization error
      throw new Error('Insufficient permissions for this operation');
    }
    
    return await response.json();
  } catch (error) {
    console.error('API request failed:', error);
    throw error;
  }
}
```

## Security Considerations

### API Key Security
1. **Storage Security**
   - Never commit keys to version control
   - Use secure environment variables
   - Encrypt keys in configuration files
   - Implement key vault solutions for production

2. **Network Security**
   - Always use HTTPS endpoints
   - Implement certificate pinning
   - Use secure network connections
   - Monitor for man-in-the-middle attacks

3. **Access Monitoring**
   ```bash
   # Monitor API key usage
   curl -X GET https://api.affelios.com/v1/auth/api-keys/usage \
     -H "Authorization: Bearer YOUR_API_KEY"
   ```

### Compliance and Auditing
1. **Access Logging**
   - Log all API requests
   - Monitor unusual access patterns
   - Implement alerting for suspicious activity
   - Maintain audit trails

2. **Key Governance**
   - Regular key rotation policies
   - Access review procedures
   - Deactivation workflows
   - Emergency revocation processes

## Testing and Development

### Test Environment
```bash
# Use test API keys for development
AFFELIOS_API_KEY="aff_test_1234567890abcdef1234567890abcdef"
AFFELIOS_API_URL="https://api-sandbox.affelios.com/v1"
```

### Authentication Testing
```bash
# Test API key validity
curl -X GET https://api.affelios.com/v1/auth/verify \
  -H "Authorization: Bearer YOUR_API_KEY"
```

### SDK Authentication Examples
```javascript
// JavaScript SDK
import { AffeliosClient } from '@affelios/api-client';

const client = new AffeliosClient({
  apiKey: process.env.AFFELIOS_API_KEY,
  environment: 'production' // or 'sandbox'
});
```

```python
# Python SDK
from affelios import Client

client = Client(
    api_key=os.environ['AFFELIOS_API_KEY'],
    environment='production'
)
```
